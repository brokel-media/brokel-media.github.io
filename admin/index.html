<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Post</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, textarea { width: 100%; padding: 0.5rem; box-sizing: border-box; }
        button { background: #24292e; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 1rem; border-radius: 4px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #login-screen { max-width: 400px; margin: 4rem auto; text-align: center; }
        .error { color: red; margin-top: 0.5rem; }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <h1>Contributor Login</h1>
        <div class="form-group">
            <input type="password" id="password-input" placeholder="Enter the password" onkeyup="if(event.key === 'Enter') login()">
        </div>
        <button onclick="login()">Unlock</button>
        <p id="login-error" class="error"></p>
    </div>

    <!-- Editor Screen -->
    <div id="editor-screen" class="hidden">
        <h1>Write a New Post</h1>
        
        <div class="form-group">
            <label>Title</label>
            <input type="text" id="post-title" placeholder="My Awesome Story">
        </div>

        <div class="form-group">
            <label>Content</label>
            <textarea id="post-body"></textarea>
        </div>

        <button id="publish-btn" onclick="publish()">Publish Post</button>
        <p id="status-msg"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
    <script type="module">
        import { config } from './config.js';

        let githubToken = null;
        let simplemde = null;

        // Repo Details
        const REPO_OWNER = 'lucaa2000';
        const REPO_NAME = 'lucaa2000.github.io';

        window.login = async function() {
            const password = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('login-error');
            
            try {
                if (config.data.length === 0) {
                    throw new Error("Configuration not found. Please run setup.html first.");
                }

                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
                );

                const key = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: new Uint8Array(config.salt), iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, true, ["decrypt"]
                );

                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: new Uint8Array(config.iv) },
                    key,
                    new Uint8Array(config.data)
                );

                githubToken = new TextDecoder().decode(decrypted);
                
                // If successful, show editor
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('editor-screen').classList.remove('hidden');
                
                // Init Markdown Editor
                simplemde = new SimpleMDE({ element: document.getElementById("post-body") });

            } catch (e) {
                console.error(e);
                errorMsg.innerText = "Incorrect password or invalid configuration.";
            }
        };

        window.publish = async function() {
            const title = document.getElementById('post-title').value;
            const body = simplemde.value();
            const btn = document.getElementById('publish-btn');
            const status = document.getElementById('status-msg');

            if (!title || !body) {
                alert('Please fill in title and content');
                return;
            }

            btn.disabled = true;
            status.innerText = "Publishing...";

            // Create filename slug
            const date = new Date();
            const dateStr = date.toISOString().split('T')[0];
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const filename = `_posts/${dateStr}-${slug}.md`;

            // Create Frontmatter
            const fileContent = `---
layout: post
title: "${title.replace(/"/g, '\\"')}"
date: ${date.toISOString()}
---

${body}`;

            // Base64 encode (handle unicode)
            const contentEncoded = btoa(unescape(encodeURIComponent(fileContent)));

            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${githubToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `New post: ${title}`,
                        content: contentEncoded
                    })
                });

                if (response.ok) {
                    status.innerText = "Success! Post published.";
                    status.style.color = "green";
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    const err = await response.json();
                    throw new Error(err.message);
                }
            } catch (e) {
                status.innerText = "Error: " + e.message;
                status.style.color = "red";
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>